name: build and deployment

on: [push]

jobs:
  builder:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Branch
      uses: actions/checkout@master
    - name: 配置环境
      uses: actions/setup-python@v1
      with:
        python-version: 3.10.16
    - name: 依赖安装
      run: |
        sudo apt install shc tree -y
        sudo pip install coscmd==1.8.6.34
        sudo pip install tccli
    - name: 执行构建
      run: |
        chmod +x build
        bash build
    - name: 仓库配置
      env:
        BUCKET: ${{ secrets.COS_BUCKET_NAME }}
        SECRET_ID: ${{ secrets.COS_SECRET_ID }}
        SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
        REGION: ap-tokyo
      run: |
        coscmd config -a $SECRET_ID -s $SECRET_KEY -b $BUCKET -r $REGION
        tccli configure set secretId $SECRET_ID
        tccli configure set secretKey $SECRET_KEY
        tccli configure set region $REGION
    - name: 制品部署
      run: |
        coscmd upload -rfs --delete ./* /
        tccli PurgePathCache --cli-unfold-argument --Paths https://shell-builder.init.ac/ --FlushType flush